# 排版技术笔记

# 0 杂感

可能接下来的很多篇都是杂感。

我们知道TeX的核心模型是box。但凡是排版，都会涉及到box，包括但不限于______（请自行填写）。如果看MathType，尤其是嵌入到doc文档中的公式，除了他的OLE属性之外，它的视觉效果本身就是个box。当然了，MathType在doc里面是怎么存的？WMF/EMF+它自己搞的一套数据结构（解析难度比CFF要简单一点）。

模型就是box，没有其他的东西了。至于你是一个线程充塞一个屏幕，还是多个线程搞版面雕花，那都是交互的事。不要搞混了。搞混了，写出来的东西就是灾难了。

我上周末说Qt 6的字体子集化效果好了一点。但确实只是好了一点。因为，Qt中做字体子集化，其中的办法很讨巧。用的是QPainterPath，然后封装成TrueType格式保存到PDF里面。好处是，确实像那么回事。坏处是，原始字体的很多信息肯定是丢了。聪明的读者自然想到，那CFF也被转换成TrueType了？是啊。三次贝塞尔曲线转二次贝塞尔曲线？是啊。用数段二次模拟一段三次。聪明的读者可能又想到：是不是hinting也丢了？是啊。当然了，很多字体没有hinting，那嵌入导出的PDF，最终生成的PDF文件，印出来会是什么鬼样。谁也不知道了。

Qt 6的QFont改进很多，可以配置variable font的属性，也可以配置shaping过程中开启的OpenType feature。好啊，排版精度高了不少呢。QFontDatabase的改进也不少，比如配置emoji字体之类。但QFontDatabase的问题是，注册字体的逻辑，其实文档是没描述清楚的。至于怎么不清楚，留与聪明的读者自行探索。

CFF2虽然常用于Variable Font，但本质上，是refinement（他们文档说的），去除了一些语焉不详的东西。如果不涉及到使用CFF2中的Variable Font相关操作，那么其实可以当作改良的CFF来用。当然了，CFF本身可以脱离于OpenType直接使用，那么CFF2必须要封装在一个OpenType的SFNT格式容器里了。所以理论上是会存在非可变的CFF2字体的。目前还没找到。但我自己创造了一个，这导致我和数位方家多年前写的工具崩了。崩归崩，修复是好修复的，改了两行。

用Qt来写代码，虽然很多人能写出来特别烂的代码。但是如果多读一点Qt本身的代码，就会很自然地跟着它那个代码风格来写。所以好代码是能激发出好代码的。当然不一定要特别好，优和良都可以嘛。

最近读MS-DOC，总感觉佶屈聱牙，或者像在英文中看abjad语言。这是因为里面很多都是匈牙利命名法。而Word的最初作者，就是匈牙利命名法的发明人。我连Word 97的格式文档都在看。里面很多缩写，我猜了个大概，写了一个术语对照表。但是呢，又想，前些年计算机博物馆不是发布了Word 1.1的源码了嘛，那就对照着看一看。你别说，你还真别说，有那味：这里面大部分缩写跟文档能对照上。而且越往后看，你就会越发现，后来的维护者采取了半匈牙利命名法，很多命名都越来越多的加上了整个单词来表达意义。这也说明，软件演进到一定程度了。

当然了，读过我写的文章的，知道有一篇Word编译的，可以对照看一看。即：
[编译MS Word 1.1a](https://zhuanlan.zhihu.com/p/48528499)。

又当然了，很多人肯定不看的，大概是：假装能看懂。探索未知的乐趣确实不是所有人都有的。

# 1 杂感

我最近脑子里面充满了回顾NTS烂活所得到的快乐和野望。NTS是什么呢？一个Java搞的下一代TeX系统。你们都没听说过？那自然，这东西烂尾了。当然，除了技术选型问题之外。排版软件，这么袖珍级别的，充满启发式思维的排版软件，都是需要理解很多材料的。我以前也讲过，排版的核心算法固然有难度，但有限。懒驴拉磨拉几年也都能懂了。但排版外的处理，要读的东西可就太多了。我觉得我现在也没读完。

快乐是：好像确实该把pTeX-ng的代码迁移到一个新形式的平台上了。是什么，无所谓，反正挖坑。重要的地方在于要把汉字排版的，特定于TeX的核心断行算法的部分，抽离出来。这就意味着我要写论文了。在写了在写了。

野望是，搞文档产品，总是有人用。我想想，可能结合我那个内部的字体软件，可以搞一个很原子化的，自由组合式的排版库。你什么牛档马档，最后落实，不都还是字符的二维有限空间组合？

最近偶尔也想，MathType如果有所更新，那么格式该是什么样子呢？好像是可以把Unicode Math和OpenType Math组合起来搞了。这……好像走得通，但是很多人搞不定这几个。（确实没几个人能搞定的）

昨天走路回窝。在想Unicode的Grapheme Cluster的匹配，是按文本的逻辑序来的。是不是可以搞一个逆形式？好像可以搞呢。

# 2 关于Digital Typography一书

上周买了一本Digital Typography。叫这名字的书有两本，一本是Richard Rubinstein写的，另一本是Knuth写的。这次买的是前者。后者我读过清华大学图书馆的副本，我也买了一个副本，还没到。

Typography有人翻译成排印学。我不大喜欢这个名字。毕竟现在这个时代，印刷和排版，已经是事实上的分离了的。所以叫做排版工艺是不错的。至于说“学”，其实对于很多人而言，是到不了这个高度的。我相信能进到这个领域的，很多人没有编程的技能，就算是遇到hyphenation算法，可能都要呲牙咧嘴。

这书里面有几处好玩的地方。

第一个是CRT上的bitmap字体绘制。这里讲了CRT的原理，加上人类视觉的局限（或特性），再加上bitmap字体，就构成了我们我们以前能够看到的文字。看完这个，我才明白现在一些复古游戏机模拟器上文字效果为什么跟以前的感觉不一样了。甚至可以推论，设备决定了字体的形态。

第二个是字体的制造方法。这个其实没有讲如何制造具体的字体。而是指制造字体的流程性方法。那么作者分了两种：自上而下的，自下而上的。这个所谓的上指的的outline，下指的是bitmap。所谓自下而上方法，就是先做最小的bitmap，最后做outline。这样能够保证在最局限的情况下的效果。

第三个是对于字体编程的看法。实话说，能拿得出手的字体编程工具，只有METAFONT。其他的，大多只存在于论文里或总有各种各样的毛病（比如说GlyphWiki的kage）。这东西真的太难了。无论是汉字还是西文，设计上虽然可以使用组件（component）来组合。但是能够以低成本且具有高描述性的语言来表示和生产，是很难的事。失败的例子很多。

第四个是教Typography的教程或者课程如何设计。这个很有意思。虽然只有两三页，但是真的要去做这种课程，讲一个月是可以了。实际上，这是作者给读者提供的一种元方法。

# 3 匠心不再独具

一般来说，夸人就可能用上匠心独具一词。这事吧，放在排版以及排版技术上说，已经很难这么讲了。

技术虽然进步，但是对于排版的细节的把握，其实是更差了。比如说，排版算法依赖程序所提供的。字体，靠着几大厂商的。但也就这，很多人还会纠结于很奇怪的问题，比如说拼音的字母形态。更别说在限定环境里充分利用已有的功能了。

据我所知，一些字体厂商其实不愿意做排版指导的（有越俎代庖之嫌）。但更多的厂商其实是不能。字体这事，现在想弄懂，实在是太难了。我这就积攒了相当多的地狱笑话。我都没想过一些厂商的技术人员的技术会有那么差。

字体方面的现状就是如此。虽然市面上有很多书，会讲一些所谓的排版知识。但这种书其实看了得不到什么收获。我经常揶揄：看完没记住就算学到了。更多的情况是很多人也不想系统了解这些平淡的知识，而喜欢闭门造车，自行理解。这个自我满足就够了，偏偏还喜欢说给别人，还振振有词。这可能就是一种平凡但清澈的愚蠢。

软件呢？就是提供给我们打包好了的排版算法的黑箱（有的是白箱）。所谓匠心，最多也就是软件制作者最初的匠心的直接副本。最近几年，有一些新软件出来。有些人就产生了“我用某软件，就代表我站在了对的方向”。这不对。无论用什么软件，最高哲学就是“定于一”。这个一就是它能不能帮“你”解决现实问题。这里面是两点，一个是应用者是自己，一个是作用范围是现实问题。

我之前也说，我喜欢关注现实问题。这跟我是个外行有关系：最初勾起我兴趣的就是直接的排版问题。我最近感觉我这外行搞得久了，好像也形成了一个认知链路，自成一系了。内行外行，如果都脱离了现实问题，那就往往会忘虚无的角度上跑。人一虚无，就要开始说胡话的。

但要说，真的有没有内行的且成体系的排版技术领域专著？我现在看不到。我自己了解到的东西就很分散。但因为接触过一系列奇怪的问题，形成了独特的直觉。这种专著太难写了，横跨领域包含但不限于：encoding/图形学/特定算法/语言特定知识。

# 4 看原型的重要性

想要了解一个东西，那么历史主义的视角是不可避免的。如果缺乏这种视角，那么往往会忽略掉要解决的问题的本质特征。

今天抽空看了Joe Becker的Multilingual Word Processing一文。Joe Becker没听说过？他是Unicode的奠基人之一。他在和其他人创建Unicode之前，一直从事计算机上的多语言环境的相关工作。

如果你了解Unicode，那么也需要看一看Multilingual Word Processing一文。当然了，如果不了解，那就更应该看了。这是一篇诞生在Unicode之前的文章。要解决的问题就是：如何把各种语言同时显示出来。80年代，大多数语言文字，其实都有了特定的编码系统。如果想要做一个编辑器，或者文本的查看器，那么随之而来的问题，就是如何把这些既有编码糅合到一起。这篇文章就给出了一个做法。虽然和Unicode不同，该文提出来的是一种糅合的协议。但从现实的角度上看，后来的Unicode实际上是在糅合的角度上做了更进一步。

所谓糅合，就是union。如果粗通一点翻译知识，那么大概就还会知道还有一种“协和”的翻译。实话说，Unicode这种东西，确实是搞多语言处理编辑的人能搞出来的东西。所以，现在的情况，Unicode也重要，非Unicode也同样重要的。所以有些人总觉得GB相关的编码里面是闭门造车，那也不对。

而编辑器的另一面呢？你显示文本就需要字体。那么多语言显示，背后就需要把字体糅合在一起。不过，现在还没有出现更进一步的字体技术。现有的技术，有时候64k的数量，已经足够的了。而且，从做字体的角度上看，一个字体往往也是往针对某个或者某几个block的unicode覆盖度去做。
